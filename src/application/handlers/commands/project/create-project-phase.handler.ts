import { CommandHandler, ICommandHandler } from '@nestjs/cqrs';
import { Inject } from '@nestjs/common';
import { ProjectPhaseDto } from '../../../dto/project/phase/project-phase.dto';
import { ProjectPhaseMapper } from '../../../mappers/project-phase.mapper';
import { ProjectPhase } from '../../../../domain/entities/project-phase.entity';
import { CreateProjectPhaseCommand } from '../../../commands/project/create-project-phase.command';
import {
  IProjectPhaseRepository,
  PROJECT_PHASE_REPOSITORY,
} from '../../../../domain/repositories/project-phase-repository.interface';

@CommandHandler(CreateProjectPhaseCommand)
export class CreateProjectPhaseHandler implements ICommandHandler<CreateProjectPhaseCommand> {
  constructor(
    @Inject(PROJECT_PHASE_REPOSITORY)
    private readonly projectPhaseRepository: IProjectPhaseRepository,
  ) {}

  async execute(command: CreateProjectPhaseCommand): Promise<ProjectPhaseDto> {
    const { dto } = command;

    // Create domain entity
    const phase = new ProjectPhase(
      '', // ID will be generated by DB
      dto.projectId,
      dto.name,
      dto.description || null,
      0, // progress default
      dto.plannedStartDate || null,
      dto.plannedEndDate || null,
      null, // actual start
      null, // actual end
      'Not Started', // Default status
      dto.sequence,
      new Date(),
      new Date(),
    );

    const created = await this.projectPhaseRepository.create(phase);
    return ProjectPhaseMapper.toDto(created);
  }
}
